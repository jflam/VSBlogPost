---
title: "Представляем R Tools for Visual Studio"
output: 
    html_document:
        theme: cosmo
        highlight: tango
---

[R — это язык программирования](https://www.r-project.org/), широко применяемый для анализа данных и разработки ПО, с развитыми функциями обработки данных. Несмотря на то, что специалисты по анализу данных используют R для написания программ, сами программы редко являются конечным результатом их работы. На основе результатов выполнения программ аналитики создают отчеты и презентации, которые используются для принятия бизнес-решений.

R Tools for Visual Studio (RTVS) - это новый инструмент Microsoft для создания программ на языке R с помощью Visual Studio, в настоящий доступный в виде предварительной версии для открытого тестирования. RTVS — продукт с открытым кодом, предоставляемый бесплатно [по лицензии MIT](https://github.com/microsoft/rtvs). Его можно [загрузить, воспользовавшись приведенными здесь инструкциями](https://microsoft.github.io/RTVS-docs/installation.html), а также [ознакомиться с документацией](https://microsoft.github.io/RTVS-docs/). 

Если вы предпочитаете видео, вот описание основных возможностей RTVS в этом формате:

<iframe width="560" height="315" src="https://www.youtube.com/embed/KPS0ytrt9SA" frameborder="0" allowfullscreen></iframe>

## Краткий обзор языка R

R — интерпретируемый язык с [сильной](https://en.wikipedia.org/wiki/Strong_and_weak_typing) [динамической](http://c2.com/cgi/wiki?DynamicTyping) типизацией, на дизайн которого оказали влияние многие другие языки. Это также [функциональный язык](https://en.wikipedia.org/wiki/Functional_programming) со значительными заимствованиями из [Scheme](https://en.wikipedia.org/wiki/Scheme_(programming_language)) и [S](https://en.wikipedia.org/wiki/S_(programming_language)). Детальное рассмотрение семантики языка находится вне рамок этой статьи, но для более близкого знакомста я рекомендую прочесть следующие две книги:

1. [Advanced R](http://adv-r.had.co.nz/)
1. [The R Inferno](http://www.burns-stat.com/documents/books/the-r-inferno/)

Далее в этой статье будут кратко рассмотрены основные возможности языка R, его библиотеки, и RTVS. Цель публикации — заинтересовать читателя в более глубоком изучении языка и его библиотек, и раскрыть его полезность как инструмента для анализа данных.

Самый быстрый способ приступить к работе с языком R — воспользоваться режимом [Read-Eval-Print Loop (REPL)](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop), который позволяет интерактивно посылать команды на выполнение интерпретатору R. В RTVS использование REPL осуществляется с помощью окна R Interactive.

Как видите, можно ввести, например, `3 + 4`, и вычисление будет произведено немедленно - компиляция не требуется:

```{r comment = NULL}
3 + 4
```

Сильная сторона R проявляется при работе с данными, так что неудивительно, что наиболее часто используемая в R структура данных - это [кадр данных (dataframe)](http://www.r-tutor.com/r-introduction/data-frame), который предоставляет удобный способ работать с табличными данными. Есть много разных способов загрузить данные в dataframe, но, пожалуй, самый легкий - прочитать их из файла или URI. Ниже приведен пример загрузки с GitHub CSV-файла с данными о местоположении аэропортов в США:

```{r}
usa_airports <- read.csv("https://raw.githubusercontent.com/jflam/VSBlogPost/master/usa_airports.dat", stringsAsFactors = TRUE)
```

В R, присваивание значений переменным производится оператором `<-`, а функции вызываются привычными круглыми скобками. Таким образом,  в данном коде вызывается стандартная библиотечная функция `read.csv()`, которой передается ссылка на CSV файл в качестве аргумента.

В RTVS можно отобразить документацию по любой библиотечной функции при помощи оператора `?`. Например, чтобы получить справку по функции `read.csv`, просто наберите `?read.csv` в REPL.

Теперь мы воспользуемся другой стандартной функцией, `head()`, чтобы отобразить первые пять строк файла - и, таким образом, получить общее представление о формате данных, с которыми мы работаем.

```{r comment = NULL}
head(usa_airports)
```

Функция `head` довольно примитивна, и её выводом является обычный текст. Это не удивительно - [R появился еще в 1993 году](https://en.wikipedia.org/wiki/R_(programming_language)), когда подобный подход был актуален. Но сейчас на дворе 2016-й, и мы вправе ожидать большего.

И такая возможность имеется! Для R сейчас уже есть много сторонних библиотек, которые связывают язык с наиболее развитой и мощной технологией отображения вывода на планете: HTML. Наиболее подходящим в данной ситуации является набор библиотек с открытым исходным кодом [htmlwidgets for R](http://www.htmlwidgets.org/). Вот те же самые данные, отображенные с использованием виджета DataTable. Мы на лету генерируем HTML-страницу с данными из `usa_airports`, и открываем браузер по умолчанию для её отображения. Полученная страница содержит _интерактивную_ таблицу: попробуйте ввести "Seattle" в строку поиска, чтобы отфильтровать только аэропорты в Сиэтле, или кликните на заголовки столбцов, чтобы изменить сортировку.

```{r}
library(DT)
datatable(usa_airports[,c("name", "city", "country", "IATA_FAA", "lat", "lon", "altitude")])
```

Если же вы предпочитаете работать с данными программно, это тоже легко и просто. Популярным инструментом для этого является [библиотека dplyr авторства Хэдли Викхэма (Hadley Wickham)](https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html). Например, если мы хотим получить список аэропортов рядом с Нью-Йорком, это легко достигается применением функции `subset` из `dplyr`:

```{r message=FALSE}
library(dplyr)
new_york_airports <- subset(usa_airports, city == "New York")
datatable(new_york_airports[,c("name", "city", "country", "IATA_FAA", "lat", "lon", "altitude")])
```

Можно производить и более сложные виды фильтрации - для примера попробуем выбрать все аэропорты в Нью-Йорке, находящиеся на высоте ниже 25 футов над уровнем моря, упорядочивая строки в выводе по высоте, и показывая только имя, высоту, широту и долготу аэропортов:

```{r}
low_nyc <- 
    usa_airports %>% 
	filter(city == "New York" & altitude < 25) %>% 
	arrange(altitude) %>% 
	select(name, altitude, lat, lon)
datatable(low_nyc)
```

Здесь мы  можем видеть пример использования более сложной синтаксической конструкции языка в виде оператора `%>%`, называемого также оператором конвеера. Этот оператор позволяет компоновать операции естественным образом, так, что они читаются слева направо. В примере выше, мы начинаем с кадра данных `usa_airports`; отфильтровываем строки, для которых условие `city == "New York" & altitude < 25` истинно; сортируем их по столбцу `altitude`; и, наконец, отбираем только столбцы `name`, `altitude`, `lat` и `lon` для конечного результата, который записывается в переменную `low_nyc`.

Если вам интересно, как именно реализован оператор конвеера, вы можете посмотреть на реализацию библиотеки [magrittr](https://github.com/smbache/magrittr). Также интересной может быть статья в блоге автора библиотеки о [влиянии конвеерного оператора `|>` из F# на дизайн magrittr](http://www.r-statistics.com/2014/08/simpler-r-coding-with-pipes-the-present-and-future-of-the-magrittr-package/)

## Отображение данных на картах

Теперь, когда у нас есть некий набор данных, можно отобразить его на интерактивной карте. [leaflet HtmlWidget](http://www.htmlwidgets.org/showcase_leaflet.html) - отличная библиотека для этого. В приведенном ниже примере кода мы возьмем полученный нами ранее при помощи `dplyr` список низкоразмещенных аэропортов Нью-Йорка, и, используя уже знакомый нам конвеерный оператор, используем `leaflet` для отображения карты с кружками аэропортов на ней, используя столбцы `lon` и `lat` для их координат, и столбец `name` для всплывающих подписей, которые появляются при клике на аэропорты.

```{r fig.width=9.5, fig.height=5}
library(leaflet)
map <- 
    low_nyc %>% 
	leaflet() %>% 
	addTiles() %>% 
	addCircles(~lon, ~lat, popup = ~name, radius = 200, color="blue", opacity = 0.8)
map
```

## В заключение

В R есть слишком много интересного, чтобы уместить это все в рамки данной статьи. Но, надеюсь, мне удалось привлечь ваше внимание и разогреть ваш аппетит к изучению этого языка. Ниже приведены ссылки на различные ресурсы, которые помогут вам узнать больше о языке и библиотеках R.

### Введение в язык программирования R

1. [An Introduction to R](https://cran.r-project.org/doc/manuals/R-intro.pdf) - официальное введение в R от команды разработчиком языка, написанное [Дэвидом Смитом (David Smith)](https://twitter.com/revodavid?lang=en), который работает в Microsoft в команде, занимающейся R.
   
1. [Introduction to R Programming](https://www.edx.org/course/introduction-r-programming-microsoft-dat204x-1) - бесплатный вводный онлайновый курс по R от Microsoft 

### Ключевые библиотеки R

1. [dplyr](https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html) - библиотека для манипуляциями над данными, позволяющая быстро и удобно привести их в вид, требуемый для дальнейшего анализа.

1. [ggplot2](http://ggplot2.org/) - библиотека для отображения данных в графическом представлении (графики, диаграммы и т.д.), основанная на идеях [грамматики графики](http://vita.had.co.nz/papers/layered-grammar.pdf) Хэдли Викхэма.

1. [ggvis](http://ggvis.rstudio.com/) - библиотека для отображения данных в HTML, использующая ту же грамматику, что и `ggplot2`.

1. [rodbc](https://cran.r-project.org/web/packages/RODBC/index.html) - позволяет работать в К с данными из ODBC-совместимых БД, таких, как SQL Server.
   
### Продукты для R от Microsoft

Компания Microsoft глубоко заинтересована в дальнейшем развитии R, и предоставляет полный стек решений для разработки ваших приложений на нем, включая среду выполнения, инструментарий разработчика, и библиотеки.

1. [R Tools for Visual Studio](https://www.visualstudio.com/en-us/features/rtvs-vs.aspx/) - бесплатное расширение для Visual Studio с открытым исходным кодом, добавляющее поддержку R в VS.

1. [Microsoft R Open](https://mran.revolutionanalytics.com/open/) - кросс-платформенный (Windows, OS X, Linux) дистрибутив R от Microsoft. Он включает в себя интеграцию с [Math Kernel Library](https://software.intel.com/en-us/intel-mkl) от Intel для ускорения [линейно-алгебраических вычислений](https://mran.revolutionanalytics.com/rro/#intelmkl1). Кроме того, в него входит также библиотека [checkpoint](https://cran.r-project.org/web/packages/checkpoint/index.html), которая позволяет другим разработчикам и пользователем, работающим с вашим приложением, использовать [точно такие же версии библиотек](https://mran.revolutionanalytics.com/rro/#reproducibility) , которые вы использовали при его создании, для воспроизводимости результатов.

1. [Microsoft R Server](https://www.microsoft.com/en-us/server-cloud/products/r-server/) - дистрибутив R с набором высокооптимизированных библиотек от Microsoft для ускоренной обработки наборов данных, которые не помещаются в оперативную память.

# И еще кое-что ...

Мы уже поговорили о нескольких интересных вещах в этой краткой статье - но, пожалуй, самое интересное в ней то, что _она была целиком написана в Visual Studio_. Документ, из которого была сгенерирована статья, был написан на языке [RMarkdown](http://rmarkdown.rstudio.com/), который является диалектом популярного [языка разметки Markdown](https://daringfireball.net/projects/markdown/) с поддержкой встроенных _выполняемых_ фрагментов кода на R.

Если вам интересно посмотреть на исходный код этой статьи, вы можете [найти его в моем репозитарии на GitHub](https://github.com/jflam/VSBlogPost).

![Скриншот RTVS со светлой темой](https://rawgit.com/jflam/VSBlogPost/master/vs_blog_post_light.png)

**Джон Лэм (John Lam)** - руководитель проектов R Tools for Visual Studio, Python Tools for Visual Studio, и облачного сервиса Jupyter Notebooks для Azure. Вместе с замечательной группой разработчиков, я работаю над инструментарием для data science. Со мной можно связаться в Твиттере [\@john_lam](https://twitter.com/john_lam), или на [GitРub](https://github.com/jflam/).

Ах да, у меня есть вакансии для разработчиков на Python - если вам это интересно, пишите мне на jflam@microsoft.com.
